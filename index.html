<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload='init()'>
    <h1> Most Watched Games on Twitch by the Years</h1><br/>
    <svg width=10000 height=10000>
    </svg>
<script>
async function init() {
    data  = await d3.csv("https://nykznykz.github.io/twitch_data.csv");
    xdomain = [0,1000000];
    xrange = [0,3000];
    ydomain = [0,10];
    yrange = [100,700];
    margin = 60
    xs = d3.scaleLinear().domain(xdomain).range(xrange);
    ys = d3.scaleLinear().domain(ydomain).range(yrange);


    
    // year filter buttons
    years = [2016,2017,2018,2019,2020,2021]
    d3.select("svg")
        .selectAll("g")
        .data(years)
        .enter()
        .append("g")
        .attr("transform", function(d, i) { return "translate(" + (i*margin) + ",20)"; })
        .attr("id","button")
        .append("text").text(function(d,i){return(years[i])})

    d3.select("svg")
    .selectAll("#button")
    .each(function(d, i)
    {
        d3.select(this).append("rect")
            .attr("id", "year")
            .attr('x', -5)
            .attr('y', -15)
            .attr('opacity', .2)
            .attr('width', 55)
            .attr('height', 20)
            .attr('stroke', 'black')
            .attr('fill', "purple")
            .on('click', function(d,i)
            {
                d3.selectAll("rect[id='year']").attr("fill", "purple")

                d3.select(this).attr("fill",  "blue")
                select_year = Number(d)
                console.log(select_year)
                refresh_chart()
            })
    })
        
    d3.select('svg')
                .append('g')
                .attr("id", "chart")
                // .attr('transform','translate(' + margin + ',' + margin + ')')

    select_year = 2016
    refresh_chart()
    

}

function refresh_chart(){

    d3.selectAll("#bar").remove()
    d3.selectAll("#bar").remove()
    console.log(select_year)
    selected_data = data.filter(function(e){return (e.Year==select_year)})
    console.log(selected_data)



    // d3.select('#chart')
    //     .selectAll('rect')
    //     .data(selected_data)
    //     .enter()
    //     .append('rect')
    //     .attr("id", "bar")
    //     .attr('x',20)
    //     .attr('y',function(d,i) {return ys(i);})
    //     .attr('width',function(d,i) {return 100;})
    //     .attr('height',10)
    //     .attr('fill', "purple")
    // d3.selectAll('#chart')
    //     .selectAll('text')
    //     .data(selected_data)
    //     .enter()
    //     .append("text")
    //     .text(function(d){return d.Game})


    elem =  d3.select('#chart')
        .selectAll('rect')
        .data(selected_data)

    elemEnter = elem.enter()
    .append("g")
    .attr("id", "bar")

    elemEnter.append('rect')
        .attr('x',20)
        .attr('y',function(d,i) {return ys(i);})
        .attr('width',function(d,i) {return xs(d.Avg_viewers);})
        .attr('height',30)
        .attr('fill', "lightblue")

    elemEnter.append("text")
        .attr("dx", function(d){return 20})
        .attr('dy',function(d,i) {return ys(i) + 20;})
        .text(function(d){return d.Game})
    
}
</script>
</body>
</html>